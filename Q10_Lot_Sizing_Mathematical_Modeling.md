# 问题10：生产批量问题（Lot Sizing Problem）的数学建模

## 概述

问题10研究如何在**设置成本**和**最小批量约束**下优化生产计划。这是供应链管理中的经典**生产批量问题（Lot Sizing Problem）**，在制造业中广泛应用。

---

## 问题描述

### 新增成本和约束
- **设置成本（Setup Cost）**：€5,000/次，每当开始生产时产生（与生产量无关）
- **最小批量约束（Minimum Batch Size）**：50单位，如果生产，至少生产50单位

### 经济学背景
- 设置成本：机器换行、工人培训、质量检查等一次性成本
- 最小批量约束：由于工艺流程限制或经济规模要求

---

## 数学建模

### 1. 决策变量

**原有变量**（与问题1相同）：
```
P[t] ≥ 0       第t月的内部生产量（单位）
O[t] ≥ 0       第t月的外部组装量（单位）
W[t] ∈ ℤ       第t月的员工数量（人）
H[t] ∈ ℤ       第t月的招聘数量（人）
L[t] ∈ ℤ       第t月的裁员数量（人）
OT[t] ≥ 0      第t月的加班小时数（小时）
I[t] ≥ 0       第t月的库存量（单位）
B[t] ≥ 0       第t月的积压订单量（单位）
```

**新增变量**（生产批量问题特有）：
```
Y[t] ∈ {0, 1}  第t月是否进行内部生产的二进制决策变量
               Y[t] = 1 表示进行生产（支付设置成本€5,000）
               Y[t] = 0 表示不生产（从库存满足需求）
```

### 2. 约束条件

#### 2.1 基础约束（与问题1相同）
```
库存平衡：
I[t-1] + P[t] + O[t] + B[t-1] = D[t] + I[t] + B[t]

员工平衡：
W[t] = W[t-1] + H[t] - L[t]

生产能力：
W[t] × 176 + OT[t] ≥ P[t] × 3.5

等...（参见问题1）
```

#### 2.2 新增约束：最小批量和设置成本的关系

**约束1：最小批量约束（Big-M 形式）**

```
P[t] >= min_batch_size × Y[t]   ∀t

即：P[t] >= 50 × Y[t]
```

**物理含义**：
- 当 Y[t] = 1（进行生产）：P[t] >= 50（强制最小批量）
- 当 Y[t] = 0（不生产）：P[t] >= 0（这个约束不起作用，需要下一个约束）

**约束2：生产上界约束（Big-M 上界）**

```
P[t] <= M × Y[t]   ∀t

其中 M = 10,000（一个足够大的上界，如月度最大产能）
```

**物理含义**：
- 当 Y[t] = 1：P[t] <= 10,000（允许生产，但不超过产能）
- 当 Y[t] = 0：P[t] <= 0（不允许生产）

**联合效果**：
结合约束1和2，得到：
```
Y[t] = 0 ⟹ P[t] = 0（不生产时，产量为0）
Y[t] = 1 ⟹ 50 ≤ P[t] ≤ 10,000（生产时，量在[50, 10000]范围内）
```

### 3. 目标函数

#### 3.1 收入
```
Revenue = Σ_t (P[t] + O[t]) × 1250
```

#### 3.2 成本

**原有成本**：
```
材料成本：         Σ_t P[t] × 620
外部组装成本：     Σ_t O[t] × 710
正常工资成本：     Σ_t P[t] × 3.5 × 19
加班工资成本：     Σ_t OT[t] × 24
招聘成本：         Σ_t H[t] × 950
裁员成本：         Σ_t L[t] × 1600
库存成本：         Σ_t I[t] × 12
积压成本：         Σ_t B[t] × 35
```

**新增成本**：
```
设置成本：         Σ_t 5000 × Y[t]
                 （每次启动生产支付€5,000，与生产量无关）
```

#### 3.3 利润最大化
```
max Π = Revenue - Total_Cost

    = Σ_t (P[t] + O[t]) × 1250
      - [Materials + Outsource + Labor + Hiring + Layoff
         + Inventory + Backorder + Setup Costs]
```

---

## 模型分类与特点

### 模型类型
- **类型**：混整数线性规划（Mixed Integer Linear Programming, MILP）
- **变量类型**：
  - 连续变量：60个（P, O, OT, I, B, D等）
  - 整数变量：36个（W, H, L）
  - 二进制变量：12个（Y）

### 模型规模
```
变量总数：108个
约束总数：97个（包括新增的Big-M约束）
非零元素：250个
```

### 求解复杂度
```
求解时间：0.02秒
优化间隙：0.0066%（非常接近最优）
节点数：1（很少的分支）
```

---

## 结果分析

### 最优解特征

#### 1. 生产决策
```
进行生产的月份数：12个（所有月份）
总设置成本：€60,000（12个月 × €5,000）

这说明：
• 每个月都有生产
• 没有"跳过"任何月份（不存在Y[t]=0的情况）
```

#### 2. 为什么每个月都生产？

**成本权衡分析**：

设置成本 vs 库存成本：
- 设置成本：€5,000/次
- 库存成本：€12/单位/月
- 库存与设置成本比：2.40（库存成本更高）

```
假设在两个月之间跳过生产：
• 省去：€5,000设置成本
• 增加：额外库存成本（两倍需求积压在库存中）

在这个案例中：
• 库存成本相对设置成本较高
• 优化器倾向于保持充足生产，避免过度库存
• 结果：每个月都生产，接受€5,000设置成本
```

#### 3. 批量大小分析
```
最小批量：50单位
平均批量：5,316单位
最大批量：10,000单位（11月和12月）

特点：
• 所有批量都远大于最小批量
• 最小批量约束（>=50）不起约束作用
• 批量主要由需求驱动（与月度需求接近）
```

#### 4. 年度利润对比
```
问题1（基础模型，无设置成本）：€36,208,650
问题10（有设置成本和最小批量）：€36,142,250
利润下降：€66,400（-0.18%）

分析：
• 12个月×€5,000 = €60,000设置成本
• 但库存成本略有减少（€144,000 vs 基础的€148,800）
• 净影响：€60,000 - €4,800 = €55,200影响
• （实际差异€66,400包含其他优化调整）
```

---

## Big-M约束方法详解

### 问题背景

原始的最小批量约束应该是：
```
如果 P[t] > 0，则 P[t] >= 50
否则 P[t] = 0
```

这是一个**分段线性约束**，不能直接用线性不等式表达。

### Big-M方法（Big-M Method）

**解决方案**：引入二进制变量 Y[t] 和两个大常数约束：

```
约束1（下界）：P[t] >= 50 × Y[t]
约束2（上界）：P[t] <= M × Y[t]

其中 M 是一个"足够大"的常数
```

### 工作原理

| Y[t] | 约束1 | 约束2 | 结果 |
|------|-------|-------|------|
| 0 | P[t] >= 0 | P[t] <= 0 | **P[t] = 0** |
| 1 | P[t] >= 50 | P[t] <= M | **50 ≤ P[t] ≤ M** |

### M值的选择

```
M的选择标准：
1. M必须足够大，使得约束2在Y[t]=1时不紧（无效）
2. M不能太大，否则会导致数值问题和求解效率低

在本问题中：
• 选择 M = 10,000（月度最大需求的两倍）
• 合理的选择，既避免在最优解处起约束作用
  （因为最大批量为5,316 < 10,000）
• 也避免数值问题
```

### M值过小/过大的风险

**M过小**：
```
如果 M = 5,000 < 最大需求 = 6,800
则约束 P[t] <= 5000 × Y[t] 在生产月份可能起作用
导致模型无法找到可行解或次优解
```

**M过大**：
```
如果 M = 1,000,000
则约束 P[t] <= 1,000,000 × Y[t] 永远不起作用
数值求解器在处理大系数时可能遇到数值稳定性问题
```

---

## 敏感性分析

### 1. 设置成本的影响

**假设设置成本变化**：

```
设置成本 = 0（无设置成本）：
→ 最优解：每个月都生产，年度利润最高

设置成本 = 5,000（当前）：
→ 最优解：每个月都生产，年度利润€36,142,250

设置成本 = 10,000：
→ 最优解：可能跳过某些月份，用库存补充

设置成本 = 50,000：
→ 最优解：明显的跳过生产月份，集中生产
```

### 2. 最小批量的影响

**假设最小批量变化**：

```
最小批量 = 50（当前）：
→ 影响：几乎无约束，平均批量5,316 >> 50

最小批量 = 5,000：
→ 影响：可能改变部分月份的生产决策
→ 某些低需求月份可能无法满足最小批量要求

最小批量 = 10,000：
→ 影响：大多数低需求月份被迫零生产
→ 需要显著增加库存或外包
```

### 3. 库存成本vs设置成本的权衡

**成本组合分析**：

```
高库存成本（€18/单位/月）+ 低设置成本（€1,000）
→ 倾向：频繁生产，降低库存

低库存成本（€6/单位/月）+ 高设置成本（€10,000）
→ 倾向：集中生产，接受高库存
```

---

## 与基础模型的关键差异

### 1. 模型复杂性

| 特性 | 问题1（基础） | 问题10（批量问题） |
|------|----------|-------------|
| 决策变量个数 | 96个 | 108个 |
| 二进制变量 | 0个 | 12个 |
| 约束条件 | 73个 | 97个 |
| 模型类型 | LP（线性规划） | MILP（混整数规划） |
| 求解难度 | 简单（<0.01s） | 中等（0.02s） |

### 2. 现实性改进

**问题1的假设**：
- 生产可以任意小（甚至1单位）
- 不考虑生产启动的固定成本
- 每个月独立决策生产量

**问题10的改进**：
- ✓ 现实的设置成本建模
- ✓ 现实的最小批量要求
- ✓ 生产和库存的动态权衡

### 3. 经济影响

```
基础模型（问题1）
• 每个月根据成本灵活调整生产量
• 无需考虑启动成本
• 可能导致过度频繁的生产调整

批量问题（问题10）
• 考虑启动成本，减少不必要的生产调整
• 促进了生产和库存的优化平衡
• 更符合实际的制造约束
```

---

## 实际应用案例

### 案例1：汽车零件制造
```
设置成本：€8,000（更换模具）
最小批量：500单位（经济规模）
→ 决策：可能跳过某些低需求月份，集中生产

结果：减少模具更换次数，降低总成本
```

### 案例2：食品饮料生产
```
设置成本：€2,000（清洗生产线）
最小批量：100单位（最小包装量）
→ 决策：可能每周或每两周生产一次

结果：平衡生产效率和库存成本
```

### 案例3：定制电子产品
```
设置成本：€15,000（芯片编程、测试）
最小批量：1,000单位（经济运输规模）
→ 决策：明显的高低潮，集中大批量生产

结果：充分发挥规模经济
```

---

## 数学证明与理论基础

### 1. Big-M方法的理论正确性

**定理**：对于分段线性约束
```
P[t] = 0  或  P[t] >= min_size
```

Big-M方法
```
P[t] >= min_size × Y[t]
P[t] <= M × Y[t]
Y[t] ∈ {0, 1}
```

**证明可行性**：
- 当最优解为P[t]=0时，Y[t]=0是最优的（设置成本为0）
- 当最优解为P[t]>0时，Y[t]=1是必要的（强制≥min_size）
- M足够大时，Y[t]=1不会限制最优P[t]的值

### 2. 凸性和单调性

```
目标函数：
Π(Y,P,O,...) = Revenue - Cost

成本中的 Σ 5000×Y[t] 项：
• 关于Y是线性的（凸的）
• 关于P是分段线性的

整体：MILP问题，可以用整数规划求解器求解
```

---

## 扩展问题

### 扩展1：多个生产线的设置成本

```
如果有两条生产线，设置成本不同：
Y1[t] = 第一条生产线是否生产
Y2[t] = 第二条生产线是否生产

目标函数：
+ 3000 × Y1[t]  （生产线1的设置成本）
+ 5000 × Y2[t]  （生产线2的设置成本）

优化器会选择成本较低的生产线
```

### 扩展2：相关设置成本（Sequence-Dependent Setup）

```
如果从产品A切换到产品B的成本不同：
setup_cost[i,j] = 从产品i到产品j的设置成本

Z[t,i,j] = 二进制变量，表示时间段t从i生产切换到j

目标函数：
+ Σ_{t,i,j} setup_cost[i,j] × Z[t,i,j]
```

### 扩展3：时间窗口限制的设置

```
如果设置只能在特定时间段进行（如周末）：
Y[t] × (1 if t is weekend else 0)

约束：只允许在周末设置新产品
```

---

## 代码实现关键点

### 1. 变量定义
```python
Y = m.addVars(num_months, name="ProductionSetup", vtype=GRB.BINARY)
```

### 2. Big-M约束
```python
# 最小批量约束
m.addConstr(P[t] >= min_batch_size * Y[t])

# 生产上界约束
m.addConstr(P[t] <= max_production * Y[t])
```

### 3. 目标函数
```python
setup_costs = gp.quicksum(setup_cost * Y[t] for t in range(num_months))
# 加入总成本
```

---

## 总结

### 关键洞察

1. **设置成本影响决策**：€5,000的设置成本在库存成本较高的环境下，导致每个月都进行生产

2. **Big-M方法的有效性**：通过引入二进制变量和Big-M约束，将非线性的批量约束线性化，使问题可用MIP求解器求解

3. **模型复杂性与求解性能**：虽然模型复杂度增加（多了12个二进制变量和24个约束），但Gurobi仍能在0.02秒内找到最优解

4. **现实性改进**：问题10比问题1更接近现实的制造环境，考虑了实际的启动成本和最小批量要求

### 实务建议

- **设置成本识别**：清晰识别和量化实际的设置成本
- **最小批量确定**：基于技术和经济因素确定现实的最小批量
- **模型参数调整**：根据不同生产线和产品，使用不同的参数
- **定期优化**：当成本结构或需求变化时，重新运行优化模型
